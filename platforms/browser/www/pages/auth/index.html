<template>

    <div class="page">

        <div class="toolbar toolbar-bottom no-hairline no-shadow">

            <button @click="checkFields" class="col button button-large button-fill">Продолжить</button>

        </div>

        <div class="page-content">

            <div class="list no-hairlines">

                <ul>

                    <li>

                        <div class="item-content item-input item-input-outline">

                            <div class="item-inner">

                                <div class="item-title item-floating-label">Логин</div>

                                <div class="item-input-wrap">

                                    <input type="number" class="login" name="{{random}}" placeholder="У000123" value="" autofocus/>

                                    <span class="input-clear-button"></span>

                                </div>

                            </div>

                        </div>

                    </li>

                    <li>

                        <div class="item-content item-input item-input-outline">

                            <div class="item-inner">

                                <div class="item-title item-floating-label">Пароль</div>

                                <div class="item-input-wrap">

                                    <input type="password" class="password" value="" placeholder="12345"/>

                                    <span class="input-clear-button"></span>

                                </div>

                            </div>

                        </div>

                    </li>

                </ul>

            </div>

            <div class="block block-strong">

                <p>Введите свой логин и нажмите кнопку <b>Продолжить</b>.</p>

            </div>

        </div>

    </div>

</template>

<style scoped>

    {{this}} .toolbar .button {
        --f7-button-border-radius: 0px;
    }

</style>

<script>

    return {

        data: function () {

            return {

            }

        },
        methods: {

            checkFields: function() {

                let component = this;
                let page = component.$el;

                let login = page.find('.login').val();
                let password = page.find('.password').val();

                if (login.length < 1) {

                    app.toast.create({
                        text: 'Слишком короткий логин!',
                        position: 'top',
                        cssClass: 'bg-color-red'
                    }).open();

                    return false;

                }

                if (password.length < 1) {

                    app.toast.create({
                        text: 'Введите пароль!',
                        position: 'top',
                        cssClass: 'bg-color-red'
                    }).open();

                    return false;

                }

                component.auth();

            },
            auth: function () {

                let component = this;
                let page = component.$el;

                let login = page.find('.login').val();
                let password = page.find('.password').val();

                let url = app.params.backend + '/auth/' + login + '/' + password;

                app.request({
                    url: encodeURI(url),
                    dataType: 'json',
                    timeout: 5000,
                    beforeSend: function () {

                        app.preloader.show();

                    },
                    success: function(response) {

                        let status = response[0].СтатусАвторизации;

                        if (status == 'Успешно') {

                            localStorage.setItem('user', JSON.stringify(response[0]) );

                            location.reload();

                        } else {

                            app.preloader.hide();

                            app.toast.create({
                                text: status,
                                position: 'top',
                                cssClass: 'bg-color-red'
                            }).open();

                        }

                    },
                    error: function() {

                        app.preloader.hide();

                        app.toast.create({
                            text: 'Нет соединение с базой!',
                            position: 'top',
                            cssClass: 'bg-color-red'
                        }).open();

                    },
                    complete: function () {

                    }
                });

            }
        },
        on: {

            pageInit: function() {

                let component = this;
                let page = component.$el;

                page.find('input').on('keypress', function (event) {

                    if(event.key === 'Enter') {

                        component.checkFields();

                    }

                });

            }

        }

    }

</script>
