<template>

    <div class="page" data-name="document">

        <div class="navbar">

            <div class="navbar-bg"></div>

            <div class="navbar-inner">

                <div class="left">

                    <a href="#" class="link back">

                        <i class="icon icon-back"></i>

                    </a>

                </div>

                <div class="title"></div>

                <div class="right">

                    <a @click="sendToServerDialog" href="#" class="link">

                        <i class="icon material-icons text-color-teal">done</i>

                    </a>

                    <a @click="search" href="#" class="link">

                        <i class="icon material-icons">find_in_page</i>

                    </a>

                    <a @click="sort" href="#" class="link sort">

                        <i class="icon material-icons">sort</i>

                        <span class="label">

                            {{#js_if "this.sortType == 'byName'"}}

                                АБВ

                            {{else}}

                                123

                            {{/js_if}}

                        </span>

                    </a>

                    <a href="#" class="link filter-open popover-open" data-popover=".popover-filter">

                        <i class="icon material-icons">compare_arrows</i>

                    </a>

                </div>

            </div>

        </div>

        <div class="popover popover-filter">

            <div class="popover-inner">

                <div class="list">

                    <ul>

                        <li data-type="all" class="item-content bg-color-red">

                            <div class="item-inner">

                                <div class="item-title">Все</div>

                            </div>

                        </li>

                        <li data-type="onlyScan" class="item-content">

                            <div class="item-inner">

                                <div class="item-title">Сканированные</div>

                            </div>

                        </li>

                        <li data-type="onlyNoScan" class="item-content">

                            <div class="item-inner">

                                <div class="item-title">Не сканированные</div>

                            </div>

                        </li>

                        <li data-type="neSobrano" class="item-content">

                            <div class="item-inner">

                                <div class="item-title">Не собрано</div>

                            </div>

                        </li>

                        <li data-type="noInDocument" class="item-content">

                            <div class="item-inner">

                                <div class="item-title">Нет в документе</div>

                            </div>

                        </li>

                    </ul>

                </div>

            </div>

        </div>

        <div class="page-content">

            <input type="text" class="barcode bg-color-gray">

            {{#if items}}

                <div class="list accordion-list">

                    <ul>

                        {{#each items}}

                            <li class="accordion-item item" data-id="{{Штрихкод}}">

                                <a class="item-link item-content">

                                    <div class="item-inner">

                                        <div class="item-title">{{Номенклатура}}</div>

                                        <div class="item-after">

                                            {{#if ДобавленИзБазы}}

                                                <span class="badge color-orange">Нет в документе</span>

                                            {{/if}}

                                            {{#if Собрано}}

                                                    <span class="badge color-teal">Собран</span>

                                            {{/if}}

                                            {{#js_if "this.Собрано == false"}}

                                                <span class="badge color-red">Не собран</span>

                                            {{/js_if}}

                                        </div>

                                    </div>

                                </a>

                                <div class="accordion-item-content">

                                    <div class="list no-hairlines-between">

                                        <ul>

                                            <div class="row no-gap">

                                                <li class="col" style="border-right: 1px solid #3b3b3b;">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Артикул</div>
                                                            <div class="item-after item-price">{{Артикул}}</div>

                                                        </div>

                                                    </div>

                                                </li>

                                                <li class="col">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Розничная цена</div>

                                                            <div class="item-after item-price">

                                                                {{#if ЦенаРозничная}}

                                                                    {{ЦенаРозничная}}

                                                                {{else}}

                                                                    {{РозничнаяЦена}}

                                                                {{/if}}

                                                            </div>

                                                        </div>

                                                    </div>

                                                </li>

                                            </div>

                                            <div class="row no-gap">

                                                <li class="col" style="border-right: 1px solid #3b3b3b;">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Количество остаток</div>

                                                            <div class="item-after item-price">

                                                                {{#if КоличествоОстаток}}

                                                                    {{КоличествоОстаток}}

                                                                {{else}}

                                                                    {{КоличествоНаСкладе}}

                                                                {{/if}}

                                                            </div>

                                                        </div>

                                                    </div>

                                                </li>

                                                <li class="col">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Количество в документе</div>

                                                            <div class="item-after item-price">{{КоличествоДокумент}}</div>

                                                        </div>

                                                    </div>

                                                </li>

                                            </div>

                                            <div class="row no-gap">

                                                {{#js_if "this.ХарактеристикаНоменклатуры.length > 1"}}

                                                    <li class="col accordion-item accordion-item-opened" style="border-right: 1px solid #3b3b3b;">

                                                        <a href="#" class="item-content item-link">

                                                            <div class="item-inner">

                                                                <div class="item-title">Характеристика</div>

                                                            </div>

                                                        </a>

                                                        <div class="accordion-item-content">

                                                            <div class="block">

                                                                <p>{{ХарактеристикаНоменклатуры}}</p>

                                                            </div>

                                                        </div>

                                                    </li>

                                                {{/js_if}}

                                                <li class="col">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Штрихкод</div>
                                                            <div class="item-after item-price">{{Штрихкод}}</div>

                                                        </div>

                                                    </div>

                                                </li>

                                            </div>

                                            <li>

                                                <div class="item-content">

                                                    <div class="item-inner">

                                                        <div class="item-title">Количество сканировано</div>

                                                        <div class="item-after input-quantity-block">

                                                            <div class="input-block margin-right">

                                                                <input type="number" name="count" data-id="{{УИД_Строки}}" class="item-count text-align-center padding-horizontal" value="{{#js_if "this.КоличествоСобрано == 0"}}1{{else}}{{КоличествоСобрано}}{{/js_if}}"/>

                                                            </div>

                                                            <div class="input-plus-block display-none">

                                                                <span class="plus">+</span>

                                                                <input type="number" name="count" data-id="{{УИД_Строки}}" class="border-color-teal item-count input-plus text-align-center padding-horizontal" value="1"/>

                                                            </div>

                                                        </div>

                                                    </div>

                                                </div>

                                            </li>

                                        </ul>

                                    </div>

                                </div>

                            </li>

                        {{/each}}

                    </ul>

                </div>

            {{/if}}

        </div>

    </div>

</template>

<style scoped>

    {{this}} .barcode {
        position: absolute;
        opacity: 0;
    }

    {{this}} .plus {
                 position: absolute;
                 top: 2px;
                 z-index: 999;
                 left: 15px;
                 color: #000;
                 font-weight: bold;
                 font-size: 16px;
             }

    {{this}} .list.accordion-list {
                 --f7-list-item-title-font-size: 12px;
                 --f7-badge-font-size: 9px;
                 --f7-list-item-min-height: 30px;
                 --f7-badge-padding: 5px 5px;
                 --f7-badge-size: 15px;
             }

    {{this}} .item-title {
        white-space: normal;
             }
    {{this}} .accordion-item-content {
                 background: #2d2d2d;
                 font-size: 11px;
                 --f7-list-item-title-font-size: 11px;
             }
    {{this}} .list .row {
                 border-bottom: 1px solid #404040;
             }
    {{this}} .accordion-item-content .accordion-item-content {
    background: #464646;
    }
    {{this}} .accordion-item-content ul {
background: transparent;
             }

    {{this}} .input-plus-block {
        position: relative;
             }

    {{this}} .input-plus-block input {
        border: 2px solid;
             }

    {{this}} .input-quantity-block {
position: relative;
             }
    {{this}} .input-quantity-block input {
                 width: 80px;
                 border-radius: 4px;
        background: #eee;
        color: #000;
        font-weight: bold;
        height: 30px;
             }

    {{this}} .input-quantity-block input::selection {
        background: #d6d6d6;
    }

    {{this}} .input-quantity-block input:focus {
                 color: #000;
             }

    {{this}} .button-save i {
                 font-size: 14px;
             }

    {{this}} .accordion-item-content .list {
                 --f7-list-item-title-font-size: 11px;
                 --f7-list-item-after-font-size: 11px;
                 --f7-list-item-min-height: 30px;
             }

    {{this}} .navbar .sort .label {
                 font-size: 8px;
                 position: absolute;
                 right: 8px;
                 bottom: -3px;
             }
</style>

<script>

    return {

        data: function () {

            return {
                sortType: 'byName'
            }

        },
        methods: {
            sendToServerDialog: function () {

                let component = this;
                let page = component.$el;

                app.dialog.create({

                    title: 'Выберите вариант',
                    buttons: [
                        {
                            text: 'Добавить',
                            bold: true,
                            cssClass: 'text-align-center',

                            onClick: function () {

                                component.sendToServer('Добавление');

                            }
                        },
                        {
                            text: 'Заменить',
                            bold: true,
                            cssClass: 'text-align-center',
                            onClick: function () {

                                component.sendToServer('Замена');

                            }
                        },
                        {
                            text: 'Замена с очищением',
                            bold: true,
                            cssClass: 'text-align-center',
                            color: 'red',
                            onClick: function () {

                                component.sendToServer('ЗаменаСОчищением');

                            }
                        },
                        {
                            text: 'Отмена',
                            bold: true,
                            color: 'gray',
                        },
                    ],
                    verticalButtons: true,
                }).open();

            },
            sendToServer: function (loadType) {

                let component = this;
                let page = component.$el;

                app.dialog.confirm('Вы готовы передать документ в 1С?', 'Внимание', function () {

                    localforage.getItem('documents').then(function (documents) {

                        let document = documents.find(function (document) {

                            return document.Номер == component.document.Номер;

                        });

                        let url = encodeURI(app.params.backend + '/transfer_doc_loadstr');

                        let data = {
                            kontragent: false,
                            login: app.params.user.code,
                            loadType: loadType,
                            document: document
                        };

                        data = JSON.stringify(data);

                        app.request({
                            url: url,
                            //async: false,
                            method: 'POST',
                            data: {
                                data: data,
                            },
                            beforeSend: function () {

                                app.dialog.preloader('Загрузка...');

                            },
                            success: function (response) {

                                app.toast.create({
                                    text: 'Ваш запрос принят!',
                                    position: 'top',
                                    cssClass: 'bg-color-teal'
                                }).open();

                                app.views.current.router.back('/main', {
                                    force: true
                                });

                                if (response.Статус == 'Успешно') {

                                    for (let i = 0; i < documents.length; i++) {

                                        if (documents[i].Номер == document.Номер) {

                                            for (let i = 0; i < documents[i].Строки.length; i++) {

                                                if (documents[i].Строки[i].ДобавленИзБазы) {

                                                    delete documents[i].Строки[i].ДобавленИзБазы;

                                                }

                                            }

                                        }

                                    }

                                    localforage.setItem('documents', documents);

                                }

                            },
                            error: function () {

                                app.toast.create({
                                    text: 'Нет соединение с базой!',
                                    position: 'top',
                                    cssClass: 'bg-color-red'
                                }).open();

                            },
                            complete: function () {

                                app.dialog.close();

                            }
                        });

                    });

                });

            },
            sort: function () {

                let component = this;
                let page = component.$el;

                if (component.sortType == 'byName') {

                    component.sortType = 'bySku';

                } else {

                    component.sortType = 'byName';

                }

                component.$update();

                component.initItems();

            },
            search: function () {

                let component = this;
                let page = component.$el;

                app.dialog.prompt('', 'Введите штрихкод', function (barcode) {

                    page.find('.barcode').val(barcode);

                    component.hideInputPlus = true;

                    component.barcodeHandler();

                });

            },
            changeCount: function () {

                let component = this;
                let page = component.$el;

                let barcode = page.find('.item.accordion-item-opened').data('id');

                let itemIndex = component.items.findIndex(function (item) {

                    if (item.Штрихкоды) {

                        return item.Штрихкоды.indexOf(barcode) !== -1;

                    } else {

                        return item.Штрихкод == barcode;

                    }

                });

                let accordion = page.find('.accordion-item[data-id="' + component.items[itemIndex].Штрихкод + '"]');

                let quantity = accordion.find('input:not(.input-plus)').val();

                if (quantity.length == 0 && quantity == '0') {

                    app.toast.create({
                        text: 'Неверное количество!',
                        cssClass: 'bg-color-red',
                        closeTimeout: 1000,
                        position: 'top'
                    }).open();

                    return false;

                }

                quantity = Number(quantity);

                component.items[itemIndex].КоличествоСобрано = quantity;

                if (component.items[itemIndex].КоличествоДокумент) {

                    if (component.items[itemIndex].КоличествоДокумент == quantity) {

                        component.items[itemIndex].Собрано = true;

                    } else {

                        component.items[itemIndex].Собрано = false;

                    }

                }

                app.toast.create({
                    text: 'Сохранение...',
                    cssClass: 'bg-color-teal',
                    closeTimeout: 1000,
                    position: 'top'
                }).open();

                accordion.find('.input-plus-block').addClass('display-none');

                accordion.find('.input-plus-block').find('input').val('1');

                component.$update();

                component.saveDocument();

                setTimeout(function () {

                    app.accordion.close(accordion);

                }, 2000);

            },
            saveDocument: function () {

                let component = this;
                let page = component.$el;

                localforage.getItem('documents').then(function (documents) {

                    for (let i = 0; i < documents.length; i++) {

                        if (documents[i].Номер == component.document.Номер) {

                            documents[i].Строки = component.items;

                        }

                    }

                    localforage.setItem('documents', documents);

                });

            },
            initItems: function (filter) {

                let component = this;
                let page = component.$el;

                if (page.find('.item.accordion-item-opened').length > 0) {

                    app.accordion.close(page.find('.item.accordion-item-opened'));

                }

                page.find('.page-content').scrollTop(0);

                localforage.getItem('documents').then(function (documents) {

                    let document = documents.find(function (document) {

                        return document.Номер == component.document.Номер;

                    });

                    component.document = document;

                    let items = component.document.Строки;

                    items = items.sort(function (a, b) {

                        let nameA = component.sortType === 'byName' ? a.Номенклатура : a.Артикул;

                        let nameB = component.sortType === 'byName' ? b.Номенклатура : b.Артикул;

                        if (nameA < nameB) {

                            return -1;

                        }

                        if (nameA > nameB) {

                            return 1;

                        }

                        return 0;

                    });

                    if (filter) {

                        items = filter(items);

                        app.toast.create({
                            text: items.length,
                            position: 'center',
                            closeTimeout: 2000
                        }).open();

                    }

                    component.items = items;

                    component.$update();

                });

            },
            filter: function (type) {

                let component = this;
                let page = component.$el;

                component.popoverFilterTimeout = setTimeout(function () {

                    app.popover.close('.popover-filter');

                    clearTimeout(component.popoverFilterTimeout);

                    component.popoverFilterTimeout = false;

                }, 500);

                let filter;

                if (type == 'all') {

                    filter = function (items) {

                        return items;

                    };

                } else if (type == 'onlyScan') {

                    filter = function (items) {

                        return items.filter(function (item) {

                            return item.КоличествоСобрано > 0;

                        });

                    }

                } else if (type == 'onlyNoScan') {

                    filter = function (items) {

                        return items.filter(function (item) {

                            return item.КоличествоСобрано == 0;

                        });

                    }

                } else if (type == 'neSobrano') {

                    filter = function (items) {

                        return items.filter(function (item) {

                            if (item.КоличествоДокумент) {

                                if ( (item.КоличествоСобрано > 0) && (item.КоличествоДокумент !== item.КоличествоСобрано) && (!item.ДобавленИзБазы) ) {

                                    return item;

                                }

                            }

                        });

                    }

                } else if (type == 'noInDocument') {

                    filter = function (items) {

                        return items.filter(function (item) {

                            return item.ДобавленИзБазы == true;

                        });

                    }

                }

                component.initItems(filter);

            },
            barcodeHandler: function () {

                let component = this;
                let page = component.$el;

                component.scanned = true;

                let barcode = page.find('.barcode').val();

                if (barcode.length == 12) {

                    barcode = '0' + barcode;

                }

                let item = component.items.find(function (item) {

                    if (item.Штрихкоды) {

                        return item.Штрихкоды.indexOf(barcode) !== -1;

                    } else {

                        return item.Штрихкод == barcode;

                    }

                });

                if (item) {

                    console.log(item);

                    let accordion = page.find('.accordion-item[data-id="' + item.Штрихкод + '"]');

                    app.accordion.open(accordion);

                } else {

                    let item_in_base = app.params.base.find(function (item) {

                        return item.Штрихкод == barcode;

                    });

                    if (item_in_base) {

                        app.dialog.confirm('Штрихкод не найден в документе, но найден в базе, добавить его в документ?', '', function () {

                            item_in_base.КоличествоСобрано = 0;

                            item_in_base.ДобавленИзБазы = true;

                            component.items.push(item_in_base);

                            component.saveDocument();

                            component.$update(function () {

                                component.barcodeHandler();

                            });

                        });

                    } else {

                        app.toast.create({
                            text: 'Штрихкод не найден!',
                            closeTimeout: 2000,
                            cssClass: 'bg-color-red',
                            position: 'top'
                        }).open();

                    }

                }

            }
        },
        on: {

            pageInit: function() {

                let component = this;
                let page = component.$el;

                component.initItems();

                component.barcodeTimeout = false;

                page.find('.barcode').on('input', function () {

                    if (!component.barcodeTimeout) {

                        component.barcodeTimeout = setTimeout(function () {

                            component.barcodeHandler();

                            clearTimeout(component.barcodeTimeout);

                            component.barcodeTimeout = false;

                        }, 300);

                    }

                });

                $$(window).off('keydown');

                $$(window).on('keydown', function(event) {

                    let key = event.keyCode;

                    if (key == 114 || key == 0 || key == 91) {

                        if ($$('.dialog.modal-in').length > 0) {

                            setTimeout(function () {

                                if ($$('.dialog.modal-in').find('input').val().length >= 12) {

                                    $$('.dialog.modal-in').find('.dialog-buttons').find('.dialog-button:last-child').click();

                                } else {

                                    let ke = new KeyboardEvent('keydown', {
                                        bubbles: true, cancelable: true, keyCode: 91
                                    });

                                    document.body.dispatchEvent(ke);

                                }

                            }, 300);

                        } else {

                            page.find('.barcode').val('');

                            page.find('.barcode').focus();

                        }

                    }

                    if (!component.popoverFilterTimeout) {

                        if (event.code == 'ArrowUp') {

                            page.find('.filter-open').click();

                            if ($$('.popover-filter').find('li.bg-color-red').prev().length > 0) {

                                $$('.popover-filter').find('li.bg-color-red').prev().click();

                            } else {

                                $$('.popover-filter').find('li:last-child').click();

                            }
                        }

                        if (event.code == 'ArrowDown') {

                            page.find('.filter-open').click();

                            if ($$('.popover-filter').find('li.bg-color-red').next().length > 0) {

                                $$('.popover-filter').find('li.bg-color-red').next().click();

                            } else {

                                $$('.popover-filter').find('li:first-child').click();

                            }

                        }

                    }

                });

                $$(window).off('accordion:beforeopen', '.page[data-name="document"] .accordion-item');

                $$(window).on('accordion:beforeopen', '.page[data-name="document"] .accordion-item', function () {

                    if (component.scanned && !component.hideInputPlus) {

                        $$(this).find('.input-plus-block').removeClass('display-none');

                        $$(this).find('.input-plus-block').find('input').focus();

                        $$(this).find('.input-plus-block').find('input')[0].select();

                    } else {

                        $$(this).find('.input-plus-block').addClass('display-none');

                        $$(this).find('.input-block').find('input').focus();

                        $$(this).find('.input-block').find('input')[0].select();

                    }

                });

                $$(window).off('accordion:opened', '.page[data-name="document"] .accordion-item');

                $$(window).on('accordion:opened', '.page[data-name="document"] .accordion-item', function () {

                    let offset = $$(this).offset();

                    page.find('.page-content').scrollTop(offset.top - 150);

                    if (component.scanned) {

                        setTimeout(function () {

                            component.scanned = false;

                        }, 100);

                    }

                });

                $$(window).off('keypress', '.page[data-name="document"] .accordion-item input');

                $$(window).on('keypress', '.page[data-name="document"] .accordion-item input', function (event) {

                    if (!component.scanned) {

                        if (event.key === 'Enter') {

                            if ($$(event.target).hasClass('input-plus')) {

                                console.log(888);

                                let increment = Number($$(this).val());

                                let value = Number($$(this).parent().parent().find('input:not(.input-plus)').val());

                                let quantity = increment + value;

                                $$(this).parent().parent().find('input:not(.input-plus)').val(quantity);

                            }

                            component.changeCount();

                        }

                    }

                });

                $$(window).on('click', '.popover-filter li');

                $$(window).on('click', '.popover-filter li', function (event) {

                    $$('.popover-filter').find('li').removeClass('bg-color-red');

                    $$(this).addClass('bg-color-red');

                    let type = $$(this).data('type');

                    component.filter(type);

                });

            }

        }

    }

</script>
