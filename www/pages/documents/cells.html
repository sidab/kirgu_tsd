<template>

    <div class="page" data-name="cell">

        <div class="navbar">

            <div class="navbar-bg"></div>

            <div class="navbar-inner">

                <div class="left">

                    <a href="#" class="link back">

                        <i class="icon icon-back"></i>

                    </a>

                </div>

                <div class="title"></div>

                <div class="right">

                    <a href="#" class="link">

                        <i class="icon material-icons text-color-teal">done</i>

                    </a>

                </div>

            </div>

        </div>

        <div class="page-content">

            <input type="text" class="barcode bg-color-gray">

            {{#if items}}

                <div class="list accordion-list">

                    <ul>

                        {{#each items}}

                            <li class="accordion-item item" data-id="{{Штрихкод}}">

                                <a class="item-link item-content">

                                    <div class="item-inner">

                                        <div class="item-title">{{Номенклатура}}</div>

                                        <div class="item-after">

                                        </div>

                                    </div>

                                </a>

                                <div class="accordion-item-content">

                                    <div class="list no-hairlines-between">

                                        <ul>

                                            <div class="row no-gap">

                                                <li class="col" style="border-right: 1px solid #3b3b3b;">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Артикул</div>
                                                            <div class="item-after item-price">{{Артикул}}</div>

                                                        </div>

                                                    </div>

                                                </li>

                                                <li class="col">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Розничная цена</div>

                                                            <div class="item-after item-price">

                                                                {{#if ЦенаРозничная}}

                                                                    {{ЦенаРозничная}}

                                                                {{else}}

                                                                    {{РозничнаяЦена}}

                                                                {{/if}}

                                                            </div>

                                                        </div>

                                                    </div>

                                                </li>

                                            </div>

                                            <div class="row no-gap">

                                                <li class="col" style="border-right: 1px solid #3b3b3b;">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Количество остаток</div>

                                                            <div class="item-after item-price">

                                                                {{#if КоличествоОстаток}}

                                                                    {{КоличествоОстаток}}

                                                                {{else}}

                                                                    {{КоличествоНаСкладе}}

                                                                {{/if}}

                                                            </div>

                                                        </div>

                                                    </div>

                                                </li>

                                                <li class="col">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Количество в документе</div>

                                                            <div class="item-after item-price">{{КоличествоДокумент}}</div>

                                                        </div>

                                                    </div>

                                                </li>

                                            </div>

                                            <div class="row no-gap">

                                                {{#js_if "this.ХарактеристикаНоменклатуры.length > 1"}}

                                                    <li class="col accordion-item accordion-item-opened" style="border-right: 1px solid #3b3b3b;">

                                                        <a href="#" class="item-content item-link">

                                                            <div class="item-inner">

                                                                <div class="item-title">Характеристика</div>

                                                            </div>

                                                        </a>

                                                        <div class="accordion-item-content">

                                                            <div class="block">

                                                                <p>{{ХарактеристикаНоменклатуры}}</p>

                                                            </div>

                                                        </div>

                                                    </li>

                                                {{/js_if}}

                                                <li class="col">

                                                    <div class="item-content">

                                                        <div class="item-inner">

                                                            <div class="item-title">Штрихкод</div>
                                                            <div class="item-after item-price">{{Штрихкод}}</div>

                                                        </div>

                                                    </div>

                                                </li>

                                            </div>

                                            <li>

                                                <div class="item-content">

                                                    <div class="item-inner">

                                                        <div class="item-title">Количество сканировано</div>

                                                        <div class="item-after input-quantity-block">

                                                            <div class="input-block margin-right">

                                                                <input type="number" name="count" data-id="{{УИД_Строки}}" class="item-count text-align-center padding-horizontal" value="{{#js_if "this.КоличествоСобрано == 0"}}1{{else}}{{КоличествоСобрано}}{{/js_if}}"/>

                                                            </div>

                                                            <div class="input-plus-block display-none">

                                                                <span class="plus">+</span>

                                                                <input type="number" name="count" data-id="{{УИД_Строки}}" class="border-color-teal item-count input-plus text-align-center padding-horizontal" value="1"/>

                                                            </div>

                                                        </div>

                                                    </div>

                                                </div>

                                            </li>

                                        </ul>

                                    </div>

                                </div>

                            </li>

                        {{/each}}

                    </ul>

                </div>

            {{/if}}

        </div>

    </div>

</template>

<style scoped>

    {{this}} .barcode {
        position: absolute;
        opacity: 0;
    }

    {{this}} .plus {
                 position: absolute;
                 top: 2px;
                 z-index: 999;
                 left: 15px;
                 color: #000;
                 font-weight: bold;
                 font-size: 16px;
             }

    {{this}} .list.accordion-list {
                 --f7-list-item-title-font-size: 12px;
                 --f7-badge-font-size: 9px;
                 --f7-list-item-min-height: 30px;
                 --f7-badge-padding: 5px 5px;
                 --f7-badge-size: 15px;
                 padding-bottom: 200px;
             }

    {{this}} .item-title {
                 white-space: normal;
             }
    {{this}} .accordion-item-content {
                 background: #2d2d2d;
                 font-size: 11px;
                 --f7-list-item-title-font-size: 11px;
             }
    {{this}} .list .row {
                 border-bottom: 1px solid #404040;
             }
    {{this}} .accordion-item-content .accordion-item-content {
                 background: #464646;
             }
    {{this}} .accordion-item-content ul {
                 background: transparent;
             }

    {{this}} .input-plus-block {
                 position: relative;
             }

    {{this}} .input-plus-block input {
                 border: 2px solid;
             }

    {{this}} .input-quantity-block {
                 position: relative;
             }
    {{this}} .input-quantity-block input {
                 width: 80px;
                 border-radius: 4px;
                 background: #eee;
                 color: #000;
                 font-weight: bold;
                 height: 30px;
             }

    {{this}} .input-quantity-block input::selection {
                 background: #d6d6d6;
             }

    {{this}} .input-quantity-block input:focus {
                 color: #000;
             }

    {{this}} .accordion-item-content .list {
                 --f7-list-item-title-font-size: 11px;
                 --f7-list-item-after-font-size: 11px;
                 --f7-list-item-min-height: 30px;
             }

</style>

<script>

    return {

        data: function () {

            return {

            }

        },
        methods: {
            findCell: function () {

                let component = this;
                let page = component.$el;

                let barcode = page.find('.barcode').val();

                let cell = app.params.cells.find(function (cell) {

                    return cell.Штрихкод == barcode;

                });

                if (cell) {

                    console.log(cell);

                    component.cellFound = true;

                    app.dialog.create({
                        title: 'Ячейка ' + cell.Наименование,
                        text: 'Теперь отсканируйте товар',
                        buttons: [
                            {
                                text: 'Отмена',
                                bold: true,
                                color: 'gray',
                            },
                        ],
                        verticalButtons: true,
                        on: {
                            close: function () {

                                component.cellFound = false;

                            }
                        }
                    }).open();

                } else {

                    app.toast.create({
                        text: 'Ячейка не найдена!',
                        closeTimeout: 2000,
                        cssClass: 'bg-color-red',
                        position: 'top'
                    }).open();

                }

            },
            findItem: function () {

                let component = this;
                let page = component.$el;

                let barcode = page.find('.barcode').val();

                let item = component.document.Строки.find(function (item) {

                    if (item.Штрихкоды) {

                        return item.Штрихкоды.indexOf(barcode) !== -1;

                    } else {

                        return item.Штрихкод == barcode;

                    }

                });

                if (item) {

                    console.log(item);

                    app.dialog.close();

                    component.cellFound = true;

                    app.dialog.create({
                        //title: 'Товар ' + item.Номенклатура,
                        //text: 'Укажите количество',
                        cssClass: 'item-set-cell-dialog',
                        content:
                            `
                            <div class="item-name">` + item.Номенклатура + `</div>` + `

                            <div class="row">

                                <div class="col label">Количество:</div>

                                <div class="col">

                                    <div class="quantity">

                                        <input type="number" value="0">

                                    </div>

                                </div>

                            </div>

                            `
                        ,
                        buttons: [
                            {
                                text: 'Отмена',
                                bold: true,
                                color: 'gray',
                            },
                        ],
                        verticalButtons: true,
                        on: {
                            opened: function () {

                                $$('.item-set-cell-dialog').find('input').focus();

                                $$('.item-set-cell-dialog').find('input')[0].select();

                            },
                            close: function () {

                                component.cellFound = false;

                            }
                        }
                    }).open();

                } else {

                    app.toast.create({
                        text: 'Товар не найден в документе!',
                        closeTimeout: 2000,
                        cssClass: 'bg-color-red',
                        position: 'top'
                    }).open();

                }

            },
            initItems: function () {

                let component = this;
                let page = component.$el;

                if (page.find('.item.accordion-item-opened').length > 0) {

                    app.accordion.close(page.find('.item.accordion-item-opened'));

                }

                page.find('.page-content').scrollTop(0);

                localforage.getItem('documents').then(function (documents) {

                    let document = documents.find(function (document) {

                        return document.Номер == component.document.Номер;

                    });

                    component.document = document;

                    let items = component.document.Строки;

                    items = items.sort(function (a, b) {

                        let nameA = component.sortType === 'byName' ? a.Номенклатура : a.Артикул;

                        let nameB = component.sortType === 'byName' ? b.Номенклатура : b.Артикул;

                        if (nameA < nameB) {

                            return -1;

                        }

                        if (nameA > nameB) {

                            return 1;

                        }

                        return 0;

                    });

                    component.items = items;

                    component.$update();

                });

            },
            itemHandler: function () {

                let component = this;
                let page = component.$el;

                let barcode = page.find('.barcode').val();

                let item = component.document.Строки.find(function (item) {

                    if (item.Штрихкоды) {

                        return item.Штрихкоды.indexOf(barcode) !== -1;

                    } else {

                        return item.Штрихкод == barcode;

                    }

                });

                console.log(item);

                let accordion = page.find('.accordion-item[data-id="' + item.Штрихкод + '"]');

                app.accordion.open(accordion);

            },
            barcodeHandler: function () {

                let component = this;
                let page = component.$el;

                let barcode = page.find('.barcode').val();

                let cell = app.params.cells.find(function (cell) {

                    return cell.Штрихкод == barcode;

                });

                let item = component.document.Строки.find(function (item) {

                    if (item.Штрихкоды) {

                        return item.Штрихкоды.indexOf(barcode) !== -1;

                    } else {

                        return item.Штрихкод == barcode;

                    }

                });

                if (item) {

                    component.itemHandler();

                } else if (cell) {

                    component.cellHandler();

                } else {

                    app.toast.create({
                        text: 'Штрихкод не найден.',
                        closeTimeout: 2000,
                        cssClass: 'bg-color-red',
                        position: 'top'
                    }).open();

                }

            }
        },
        on: {

            pageInit: function() {

                let component = this;
                let page = component.$el;

                component.initItems();

                component.barcodeTimeout = false;

                page.find('.barcode').on('input', function () {

                    if (!component.barcodeTimeout) {

                        component.barcodeTimeout = setTimeout(function () {

                            component.barcodeHandler();

                            clearTimeout(component.barcodeTimeout);

                            component.barcodeTimeout = false;

                        }, 300);

                    }

                });

                $$(window).off('keydown');

                $$(window).on('keydown', function(event) {

                    let key = event.keyCode;

                    if (key == 114 || key == 0 || key == 91) {

                        page.find('.barcode').val('');

                        page.find('.barcode').focus();

                    }

                });

                $$(window).off('accordion:opened', '.page[data-name="cell"] .accordion-item');

                $$(window).on('accordion:opened', '.page[data-name="cell"] .accordion-item', function () {

                    let offset = $$(this).offset();

                    page.find('.page-content').scrollTop(offset.top - 150);

                    if (component.scanned) {

                        setTimeout(function () {

                            component.scanned = false;

                        }, 100);

                    }

                });

            }

        }

    }

</script>
